<?phprequire_once dirname ( __FILE__ ) . '/view/errors.inc.php';require_once dirname ( __FILE__ ) . '/services/AppServiceImpl.class.php';if(!isset($_SESSION)) session_start(); // Start session// Already connected as Admin or Provider ?if( ( isset($_SESSION['adminConnected']) && !empty($_SESSION['adminConnected']) ) ||     ( isset($_SESSION['isStoreOrProvider']) && !empty($_SESSION['isStoreOrProvider']) && $_SESSION['isStoreOrProvider'] != 'store' )  ) {    header('Location: ./disconnection.php'); // User disconnected}header( 'content-type: text/html; charset=utf-8' ); // Specifies to the server to return UTF-8 - put in prod$appService = AppServiceImpl::getInstance();if( isset($_POST) && !empty($_POST) && !isset($_POST['submitParticipants']) ) {        // Creation of a new Participant    $civility = trim( (string) $_POST['newParticipantCivility'] );    $surname  = trim( (string) $_POST['newParticipantSurname'] );    $name     = trim( (string) $_POST['newParticipantName'] );    $email    = trim( (string) $_POST['newParticipantEMail'] );    $participantToRegister = $appService->createParticipant($civility,$surname,$name,$email);        // Registration    $idParticipantSaved = $appService->saveParticipant($participantToRegister); // Returns 0 or > 0        if($idParticipantSaved) { // If insertion OK        $appService->saveAssignmentParticipantEnterprise($appService->createAssignmentParticipantEnterprise($appService->findOneParticipant($idParticipantSaved),$_SESSION['enterpriseConcerned']));        $appService->saveAssignmentParticipantDepartment($appService->createAssignmentParticipantDepartment($appService->findOneParticipant($idParticipantSaved),$_SESSION['enterpriseConcerned']->getOneDepartment()));    }}elseif( isset($_POST) && !empty($_POST) && isset($_POST['submitParticipants']) & !empty($_POST['submitParticipants']) ) {        $choiceOk = 0;        unset($_POST['submitParticipants']);        $arrayParticipants = array();        if( isset($_POST['participants']) && !empty($_POST['participants']) ) {                $choiceOk = 1;            foreach($_POST['participants'] as $value) {            $idParticipant = (int) substr($value, 14);            $arrayParticipants[] = $appService->findOneParticipant($idParticipant);         }        foreach($arrayParticipants as $value) {            $appService->saveParticipation($appService->createParticipation($value,$_SESSION['purchasingFairConcerned'],'123456',0));        }    }}$arrayParticipationsAlreadyRegistered = $appService->findAllParticipationsByEnterpriseAndPurchasingFair($_SESSION['enterpriseConcerned'],$_SESSION['purchasingFairConcerned']);// Added 27.08.2018 - Taking others Pf into account$isOtherPf = ( $_SESSION['purchasingFairConcerned']->getOneTypeOfPf()->getNameTypeOfPf() === 'Autre' ) ? true : false;?><!DOCTYPE html><html lang="fr"><head>    <meta charset="utf-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="theme-color" content="#0b70b5"><!-- Mobile browser Tab Color -->    <title>PFManagement | Choix des participants</title>    <!-- Bootstrap -->    <link href="css/bootstrap.min.css" rel="stylesheet">        <!-- Font Awesome -->    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">        <!-- Hover -->    <link href="css/plugins/hover.css/hover-min.css" rel="stylesheet">        <!-- iCheck -->    <link href="css/plugins/iCheck/custom.css" rel="stylesheet">        <!-- Toastr style -->    <link href="css/plugins/toastr/toastr.min.css" rel="stylesheet">    <!-- Animate -->    <link href="css/animate.css" rel="stylesheet">        <!-- Global -->    <link href="css/style.css" rel="stylesheet">        <!-- Custom style -->    <style>    /* Widget */    .widget { color:#ffffff;border:1px solid #ffffff; }    .ibox-title { border-top:2px solid #0b70b5; }    /* ibox */    .ibox-title h5 { color:#0b70b5; }    /* Check/uncheck all action */    .checkUncheckAll {cursor:pointer; }    /* Navigation buttons */    #previousButton { background-color:#ffffff;color:#0b70b5;border:1px solid #0b70b5; }    #nextButton { background-color:#0b70b5;color:#ffffff;border:1px solid #000000; }    /* Check value entered inputs*/    .errorInput { border:1px solid #FF0000; }    .successInput { border:1px solid #008000; }    /*Create a new participant button */    #addNewParticipantButton { background-color:#ffffff;color:#0b70b5;border:1px solid #0b70b5; }    #submitParticipants { border:1px solid #000000; }    /* Replace the icon of the button */    .hvr-icon-float-away:before { content: "\f234"; }    /* Update - Delete icons */    .fa { cursor:pointer; }    </style></head><body>    <div id="wrapper">        <?php require_once dirname ( __FILE__ ) . '/view/menu.store.inc.php'; ?>        <div id="page-wrapper" class="gray-bg">        <div class="row border-bottom">        <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">        <div class="navbar-header">            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>        </div>            <ul class="nav navbar-top-links navbar-right">                <li>                    <span class="m-r-sm text-muted welcome-message">Choix des participants RDV GT.</span>                </li>                <li>                    <a href="./disconnection.php">                        <i class="fa fa-sign-out"></i> Quitter                    </a>                </li>            </ul>        </nav>        </div>            <div class="row wrapper border-bottom white-bg page-heading">                <div class="col-lg-9">                    <h2><i class="fa fa-users" aria-hidden="true"></i> Choix des participants</h2>                    <ol class="breadcrumb">                        <li>                            <a href="./purchasing_fair_list.php">Liste des RDV GT</a>                        </li>                        <li class="active">                            <strong>Choix des participants</strong>                        </li>                    </ol>                </div>                <div class="col-lg-3">                    <?php require_once dirname ( __FILE__ ) . '/view/widget_pf_info.inc.php'; ?>                </div>            </div>                        <div class="row">                                <?php if(!$isOtherPf) { ?>                <div class="col-lg-12 animated fadeInDown alert alert-success m-t-md">                <?php                echo '<h5><i class="fa fa-info-circle" aria-hidden="true"></i> Participation(s) déjà enregistrée(s)</h5>';                $counter = 0;                $limit = count($arrayParticipationsAlreadyRegistered);                if( $limit ) {                    foreach($arrayParticipationsAlreadyRegistered as $value) {                        $counter++;                        echo '<span id="rowParticipation_'.$counter.'">';                        echo $value->getOneParticipant();                        echo '&nbsp;|&nbsp;';                        echo '<i class="fa fa-window-close text-danger" title="Supprimer" aria-hidden="true" onclick="deleteParticipation('.$counter.','.$value->getOneParticipant()->getIdParticipant().','.$value->getOnePurchasingFair()->getIdPurchasingFair().');"></i>';                        echo '</span>';                        echo ($counter < $limit) ? '<br>' : '';                    }                }                else { echo 'Aucune participation enregistrée'; }                ?>                </div>                <?php } ?>                                <div class="col-lg-offset-3 col-lg-6 m-t-md">                    <div class="ibox float-e-margins animated fadeInDown">                        <div class="ibox-title">                            <h5>Formulaire</h5>                            <?php if(!$isOtherPf) { ?>                            <div class="alert alert-warning m-t-md text-center">                                <span>                                    Vous avez saisi <span id="infoNbParticipants" class="badge"></span> participant(s)                                </span><br><br>                                <span class="checkUncheckAll" onclick="checkAllCheckboxes();">                                    <i class="fa fa-check-square-o" aria-hidden="true"></i> Tout cocher                                </span> |                                 <span class="checkUncheckAll" onclick="uncheckAllCheckboxes();">                                    <i class="fa fa-square-o" aria-hidden="true"></i> Tout décocher                                </span>                            </div>                            <?php } ?>                        </div>                        <div class="ibox-content">                            <div class="row">                                                                <form id="choiceParticipantsForm" class="col-lg-12" role="form" action="#" method="POST">                                <?php                                $apeTest = $appService->findAllAssignmentsParticipantEnterpriseForOneEnterprise($_SESSION['enterpriseConcerned']->getIdEnterprise());                                // strcasecmp — Binary safe case-insensitive string comparison                                // Returns < 0 if str1 is less than str2; > 0 if str1 is greater than str2, and 0 if they are equal.                                function compareStrings($a, $b) {                                    $result = strcasecmp($a->getOneParticipant()->getSurname(), $b->getOneParticipant()->getSurname());                                   // IF equal we compare the name                                   return (!$result) ? strcasecmp($a->getOneParticipant()->getName(), $b->getOneParticipant()->getName()) : $result;                                 }                                usort($apeTest, 'compareStrings');                                foreach( $apeTest as $value ) {                                    echo '<div class="i-checks"><label> <input type="checkbox" name="participants[]" value="idParticipant_'.$value->getOneParticipant()->getIdParticipant().'"> <i></i> '.$value->getOneParticipant().' </label></div>';                                }                                                                if( empty($apeTest) ) echo '<p class="text-danger text-center"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Liste des participants rattachés à votre Magasin vide.</p>';                                ?>                                <div class="text-center col-lg-12 m-t-xl m-b-xl" style="padding:0">                                    <button type="button" id="addNewParticipantButton" name="addNewParticipantButton" class="col-lg-6 full-width btn hvr-icon-float-away" data-toggle="modal" data-target="#myModal">Pas dans la liste ? Créer un nouveau participant</button>                                    <?php if(!$isOtherPf) { ?>                                        <button id="submitParticipants" name="submitParticipants" value="submitParticipants" type="submit" class="col-lg-6 full-width btn btn-primary hvr-icon-bounce"> Valider les participations</button>                                        <?php } ?>                                </div>                                </form>                            </div><!-- ./row -->                        </div>                        <?php if(!$isOtherPf) { ?>                        <div class="ibox-footer">                            <button id="nextButton" name="nextButton" type="button" class="btn hvr-icon-forward pull-right">Suivant</button>                            <button id="previousButton" name="previousButton" type="button" class="btn hvr-icon-back">Précédent</button>                        </div>                        <?php } ?>                    </div>                </div>                            </div><!-- ./row -->                        <div class="row" style="height:40px"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">&nbsp;</div></div>            <div class="footer">                <div class="pull-right">                    <strong><i class="fa fa-copyright" aria-hidden="true"></i></strong> E.Leclerc | SCA Ouest <?php echo date('Y'); ?>                </div>                <div>                    <strong>PFManagement</strong>                </div>            </div>        </div>        </div>    <!-- Mainly scripts -->    <script src="js/jquery-3.1.1.min.js"></script>    <script src="js/bootstrap.min.js"></script>    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>        <!-- iCheck -->    <script src="js/plugins/iCheck/icheck.min.js"></script>        <!-- Toastr script -->    <script src="js/plugins/toastr/toastr.min.js"></script>        <!-- Bootbox -->    <script src="js/plugins/bootbox.js/bootbox.min.js"></script>    <!-- Custom and plugin javascript -->    <script src="js/inspinia.js"></script>    <script src="js/plugins/pace/pace.min.js"></script>        <!-- Bootbox -->    <script src="js/plugins/bootbox.js/bootbox.min.js"></script>    <script language="javascript" type='text/javascript'>        function session(){            window.location="disconnection.php"; //page de déconnexion        }        setTimeout("session()",600000); //ça fait bien 5min??? c'est pour le test    </script>    <!-- Custom script -->    <script>    // icheck class    $(document).ready(function () {        $('.i-checks').iCheck({            checkboxClass: 'icheckbox_square-green',            radioClass: 'iradio_square-green'        });    });        // Nbparticipants => Default zero    $("#infoNbParticipants").text("0");        // Check i checkbox are checked/unchecked, conflict with JQuery listeners    // paseInt : The radix parameter is used to specify which numeral system to be used    $('input').on('ifChecked', function(event){ $("#infoNbParticipants").text( parseInt( $("#infoNbParticipants").text(),10) + 1 ); });    $('input').on('ifUnchecked', function(event){ $("#infoNbParticipants").text( parseInt( $("#infoNbParticipants").text(),10) - 1 ); });        // Check/Uncheck All Checkboxes    function checkAllCheckboxes() { $('input').iCheck('check'); }    function uncheckAllCheckboxes() { $('input').iCheck('uncheck'); }        // Previous/Next buttons    $("#previousButton").click(function(){ window.location.assign("./store_unavailabilities_register.php"); });    $("#nextButton").click(function(){ window.location.assign("./store_Prise_RDV_with_provider.php"); });        // Check the register of a new Participant via modal    // Be careful : bug if .click() used, prefer .on('click'...)    // Modal is not ready with $(document).ready function. It becomes ready when it pops-up -> .click() does not work.    // If you load HTML content dynamically (AJAX call for example, modals) and you want to binder an event on this content,     // you will have to go through the function $ (...). (...),     // the click() function applies to the elements present in the DOM during the initial loading of the page :)    // Src 1 : https://stackoverflow.com/questions/22178892/jquery-click-event-not-working-in-bootstrap-modal    // Src 2 : https://www.grafikart.fr/forum/topics/20546    // Src 3 : https://stackoverflow.com/questions/9122078/difference-between-onclick-vs-click    $(document).on('click', '#saveNewParticipantButton', function() {                var isOK = true;                if( $("#newParticipantCivility").val() == 0) {            isOK = false;            $("#newParticipantCivility").addClass("errorInput");        } else { $("#newParticipantCivility").addClass("successInput"); }                if( $.trim( $("#newParticipantSurname").val() ) === '') {            isOK = false;            $("#newParticipantSurname").addClass("errorInput");        } else { $("#newParticipantSurname").addClass("successInput"); }                if( $.trim( $("#newParticipantName").val() ) === '') {            isOK = false;            $("#newParticipantName").addClass("errorInput");        } else { $("#newParticipantName").addClass("successInput"); }                if( $.trim( $("#newParticipantEMail").val() ) === '') {            isOK = false;             $("#newParticipantEMail").addClass("errorInput");        } else { $("#newParticipantEMail").addClass("successInput"); }        if (isOK === true) $("#saveNewParticipantForm").submit();     });    <?php if( isset($_POST) && !empty($_POST) && isset($idParticipantSaved) && $idParticipantSaved) { ?>    toastr.success('Nouveau Participant enregistré.', 'OK.');    <?php } if(isset($_POST) && !empty($_POST) && isset($idParticipantSaved) && !$idParticipantSaved && !isset($choiceOk)) { ?>    toastr.error('Participant non renregistré (existe déjà).', 'Échec');    <?php } if(isset($choiceOk) && !empty($choiceOk)) { ?>    toastr.success('Participation(s) enregistrée(s)', 'Succès');    <?php } if(isset($choiceOk) && empty($choiceOk)) { ?>    toastr.error('Merci de choisir au moin un participant.', 'Échec');    <?php } ?>    bootbox.setDefaults({ locale: "fr" });            function deleteParticipation(rowId, idParticipant, idPurchasingFair) {                    bootbox.confirm("Confirmer la suppression ?", function(result) {                                     if(result === true) {                                $.post(                    './ajax/deleteParticipation.php',                    {                        idParticipant    : idParticipant,                        idPurchasingFair : idPurchasingFair                    },                    function(data) {                        if(data.trim() === 'Success') {                            $('#rowParticipation_' + rowId).html('<span class="text-danger"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;Participation supprimée.</span>');                            toastr.success('Action réussie', 'Succès.');                        }                        else {                            toastr.error('Erreur fatale. Contactez l\'administrateur.', 'Échec.');                        }                    },                    'text'                );                            }        });            }    </script>        <!--     ---- Bug Internet Explorer 30/01/2018 : Bootstrap modal appearing under background    ---- Easiest way is to just move the modal div so it is outside any elements with special positioning.     ---- One good place might be just before the closing body tag </body>.    ---- Src : https://stackoverflow.com/questions/10636667/bootstrap-modal-appearing-under-background    -->    <div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">        <div class="modal-dialog">            <div class="modal-content animated fadeIn">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>                    <i class="fa fa-user-plus fa-2x"></i>                    <h4 class="modal-title">Nouveau participant</h4>                </div>                <div class="modal-body">                    <form id="saveNewParticipantForm" role="form" action="./store_choice_participants.php" method="POST">                        <div class="form-group"><label>Civilité</label>                            <select id="newParticipantCivility" name="newParticipantCivility" class="form-control" required="">                                <option value="0">-- Choix civilité --</option>                                <option value="Madame">Madame</option>                                <option value="Monsieur">Monsieur</option>                            </select>                        </div>                        <div class="form-group"><label>Nom</label>                            <input type="text" id="newParticipantSurname" name="newParticipantSurname" maxlength="50" class="form-control" required="">                        </div>                        <div class="form-group"><label>Prénom</label>                            <input type="text" id="newParticipantName" name="newParticipantName" maxlength="50" class="form-control" required="">                        </div>                        <div class="form-group"><label>E-mail</label>                            <input type="email" id="newParticipantEMail" name="newParticipantEMail"  maxlength="100" class="form-control" required="">                        </div>                    </form>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-white" data-dismiss="modal" style="margin:0!important">Fermer</button>                    <button id="saveNewParticipantButton" type="button" class="btn btn-primary">Enregistrer</button>                </div>            </div>        </div>    </div>    </body></html>