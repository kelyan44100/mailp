<?phprequire_once dirname ( __FILE__ ) . '/view/check_pf_clotured.inc.php';if( isset($isClotured) && $isClotured) { header('Location: ./purchasing_fair_list.php'); /*die();*/ }require_once dirname ( __FILE__ ) . '/view/errors.inc.php';require_once dirname ( __FILE__ ) . '/services/AppServiceImpl.class.php';if(!isset($_SESSION)) session_start(); // Start session// Not connected as Admin ?if(!isset($_SESSION['enterpriseConcerned']) && empty($_SESSION['enterpriseConcerned'])) {    header('Location: ./disconnection.php'); // Redirection to Purchasing Fair list}header( 'content-type: text/html; charset=utf-8' ); // Specifies to the server to return UTF-8 - put in prod$appService = AppServiceImpl::getInstance();if( isset($_POST) && !empty($_POST) ) {        // Creation of a new Participant    $civility = trim( (string) $_POST['newParticipantCivility'] );    $surname  = trim( (string) $_POST['newParticipantSurname'] );    $name     = trim( (string) $_POST['newParticipantName'] );    $email    = trim( (string) $_POST['newParticipantEMail'] );    $participantToRegister = $appService->createParticipant($civility,$surname,$name,$email);    $idParticipantSaved = $appService->saveParticipant($participantToRegister); // Returns 0 or > 0        if($idParticipantSaved) { // If insertion OK        $appService->saveAssignmentParticipantEnterprise($appService->createAssignmentParticipantEnterprise($appService->findOneParticipant($idParticipantSaved),$_SESSION['enterpriseConcerned']));        $appService->saveAssignmentParticipantDepartment($appService->createAssignmentParticipantDepartment($appService->findOneParticipant($idParticipantSaved),$_SESSION['enterpriseConcerned']->getOneDepartment()));        // $appService->saveParticipation($appService->createParticipation($appService->findOneParticipant($idParticipantSaved),$_SESSION['purchasingFairConcerned'],'123456',0));    }}/* The participation of a Salesperson is different from Participants of a Store that is found in the findAllByEnterpriseAndPurchasingFair () Service method.  * You have to know if the Salesperson has been assigned to a Store or not (table assignment_sp_store), depending on the Enterprise (as Provider) and the PurchasingFair being viewed. */$arrayASSRegistered = $appService->findOneAssignmentSpStoreBis($_SESSION['enterpriseConcerned']->getIdEnterprise(), $_SESSION['purchasingFairConcerned']->getIdPurchasingFair());$arrayEnterprisesAssigned = $appService->summaryOfAssignedStores($_SESSION['enterpriseConcerned']->getIdEnterprise(), $_SESSION['purchasingFairConcerned']->getIdPurchasingFair());// Added 27.08.2018 - Taking others Pf into account$isOtherPf = ( $_SESSION['purchasingFairConcerned']->getOneTypeOfPf()->getNameTypeOfPf() === 'Autre' ) ? true : false;?><!DOCTYPE html><html lang="fr"><head>    <meta charset="utf-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="theme-color" content="#0b70b5"><!-- Mobile browser Tab Color -->    <title>PFManagement | Choix du responsable de commissions</title>    <!-- Bootstrap -->    <link href="css/bootstrap.min.css" rel="stylesheet">        <!-- Font Awesome -->    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">        <!-- Hover -->    <link href="css/plugins/hover.css/hover-min.css" rel="stylesheet">        <!-- Select2 -->    <link href="css/plugins/select2/select2.min.css" rel="stylesheet">        <!-- iCheck -->    <link href="css/plugins/iCheck/custom.css" rel="stylesheet">        <!-- Toastr style -->    <link href="css/plugins/toastr/toastr.min.css" rel="stylesheet">    <!-- Animate -->    <link href="css/animate.css" rel="stylesheet">        <!-- Global -->    <link href="css/style.css" rel="stylesheet">        <!-- Custom style -->    <style>    /* Widget */    .widget { color:#ffffff;border:1px solid #ffffff; }    .ibox-title { border-top:2px solid #0b70b5; }    /* ibox */    .ibox-title h5 { color:#0b70b5; }    /* Check/uncheck all action */    .checkUncheckAll {cursor:pointer; }    /* Navigation buttons */    #previousButton { background-color:#ffffff;color:#0b70b5;border:1px solid #0b70b5; }    #nextButton { background-color:#0b70b5;color:#ffffff;border:1px solid #000000; }    /* Check value entered inputs*/    .errorInput { border:1px solid #FF0000; }    .successInput { border:1px solid #008000; }    /*Create a new participant button */    #addNewParticipantButton { background-color:#ffffff;color:#0b70b5;border:1px solid #0b70b5; }    #associateExistingSalespersonButton { background-color:#0b70b5;color:#ffffff;border:1px solid #ffffff; }    /* Update - Delete icons */    .fa { cursor:pointer; }    </style></head><body>    <div id="wrapper">        <?php require_once dirname ( __FILE__ ) . '/view/menu.provider.inc.php'; ?>        <div id="page-wrapper" class="gray-bg">        <div class="row border-bottom">        <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">        <div class="navbar-header">            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>        </div>            <ul class="nav navbar-top-links navbar-right">                <li>                    <span class="m-r-sm text-muted welcome-message">Choix du responsable de commission.</span>                </li>                <li>                    <a href="./disconnection.php">                        <i class="fa fa-sign-out"></i> Quitter                    </a>                </li>            </ul>        </nav>        </div>            <div class="row wrapper border-bottom white-bg page-heading">                <div class="col-lg-9">                    <h2><i class="fa fa-id-badge" aria-hidden="true"></i> Choix du responsable de commission</h2>                    <ol class="breadcrumb">                        <li>                            <a href="./purchasing_fair_list.php">Liste des salons</a>                        </li>                        <li class="active">                            <strong>Choix du responsable de commission</strong>                        </li>                    </ol>                </div>                <div class="col-lg-3">                    <?php require_once dirname ( __FILE__ ) . '/view/widget_pf_info.inc.php'; ?>                </div>            </div>                        <div class="row">                                <?php if(!$isOtherPf) { ?>                <div class="col-lg-12 animated fadeInDown alert alert-success m-t-md" style="margin-bottom:5px;">                <?php                echo '<h5><i class="fa fa-info-circle" aria-hidden="true"></i> Participation(s) déjà enregistrée(s) - Possibilité de supprimer les participations</h5>';                $counter = 0;                $limit = count($arrayASSRegistered);                // To prevent duplicates                $arraySalespersonsPrinted = array();                if( $limit ) {                    foreach($arrayASSRegistered as $ass) {                        if( !in_array($ass->getOneParticipant()->getIdParticipant(), $arraySalespersonsPrinted) ) {                            $counter++;                            echo '<span id="rowASS_'.$counter.'">';                            echo $ass->getOneParticipant();                            echo '&nbsp;|&nbsp;';                            echo '<i class="fa fa-window-close text-danger" title="Supprimer" aria-hidden="true" onclick="deleteASS('.$counter.','.$ass->getOneParticipant()->getIdParticipant().','.$ass->getOneProvider()->getIdEnterprise().','.$ass->getOnePurchasingFair()->getIdPurchasingFair().');"></i>';                            echo '</span>';                            echo ($counter < $limit) ? '<br>' : '';                            $arraySalespersonsPrinted[] = $ass->getOneParticipant()->getIdParticipant();                        }                    }                }                else { echo 'Aucune participation enregistrée'; }                ?>                </div>                                <div class="col-lg-12 animated fadeInDown alert alert-dismissable alert-info" style="margin-top:0px;">                <button aria-hidden="true" data-dismiss="alert" class="close" type="button" title="Enlever">×</button>                <?php                echo '<h5><i class="fa fa-info-circle" aria-hidden="true"></i> Liste des fournisseurs sélectionnés</h5>';                $counter2 = 0;                $limit2   = count($arrayEnterprisesAssigned);                if( $limit2 ) {                    foreach($arrayEnterprisesAssigned as $enterprise) {                        $counter2++;                        echo '<span>';                        echo $enterprise->getName();                        echo '</span>';                        echo ($counter2 < $limit2) ? ', ' : '';                    }                }                else { echo 'Aucune entreprise sélectionnée'; }                ?>                </div>                <?php } ?>                                <div class="col-lg-offset-3 col-lg-6 m-t-md">                    <div class="ibox float-e-margins animated fadeInDown">                        <div class="ibox-title">                            <h5>Formulaire</h5>                            <?php if(!$isOtherPf) { ?>                            <div class="alert alert-warning m-t-md text-center">                                <span>                                    Vous avez saisi <span id="infoNbParticipants" class="badge"></span> participant(s)                                </span><br><br>                                <span class="checkUncheckAll" onclick="checkAllCheckboxes();">                                    <i class="fa fa-check-square-o" aria-hidden="true"></i> Tout cocher                                </span> |                                 <span class="checkUncheckAll" onclick="uncheckAllCheckboxes();">                                    <i class="fa fa-square-o" aria-hidden="true"></i> Tout décocher                                </span>                            </div>                            <?php } ?>                            <div class="alert alert-danger m-t-md text-center">                                <span>                                <i class="fa fa-bullhorn" aria-hidden="true"></i> Supprimer votre Responsable de commission de la liste suivante efface également TOUTES ses affectations Fournisseurs.                                </span>                            </div>                        </div>                        <div class="ibox-content">                            <div class="row">                                                                <form id="choiceSalespersonsForm" class="col-lg-12" role="form" action="./admin_list_of_stores_by_salesperson" method="POST">                                <?php                                $apeTest                      = $appService->findAllAssignmentsParticipantEnterpriseForOneEnterprise($_SESSION['enterpriseConcerned']->getIdEnterprise());                                $arrayIdparticipantsOfApeTest = array();                                $apeTest                      = $appService->sortParticipantsBySurnameAndName($apeTest);                                foreach( $apeTest as $value ) {                                    $arrayIdparticipantsOfApeTest[] = $value->getOneParticipant()->getIdParticipant();                                    echo '                                    <div class="i-checks" id="rowParticipant_'.$value->getOneParticipant()->getIdParticipant().'">                                        <label>                                            <input type="checkbox" name="participants[]" value="idParticipant_'.$value->getOneParticipant()->getIdParticipant().'"> <i></i> '.$value->getOneParticipant().'                                        </label>                                        <i class="fa fa-times-circle-o text-danger" aria-hidden="true" onclick="deleteAPEAndASS('.$value->getOneParticipant()->getIdParticipant().','.$value->getOneEnterprise()->getIdEnterprise().','.$_SESSION['purchasingFairConcerned']->getIdPurchasingFair().')"></i>                                    </div>';                                }                                                                if( empty($apeTest) ) echo '<p class="text-danger text-center"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Liste des responsables de commission.</p>';                                ?>                                <div class="alert alert-info m-t-md">                                    <p class="text-center"><i class="fa fa-info-circle" aria-hidden="true"></i> Choix d'un responsable de commission.</p>                                    <select id="selectExistingSalespersons" name="selectExistingSalespersons[]"  class="form-group form-control full-width" multiple="multiple">                                        <option value="">--- Choix Commercial (NOM Prénom) ---</option>                                        <?php                                         $arraySalespersons = $appService->findAllParticipantsAsSalespersons();                                        $arraySalespersons = $appService->sortParticipantsBySurnameAndNameBis($arraySalespersons);                                        foreach($arraySalespersons as $key => $value) {                                            if(!in_array($value->getIdParticipant(), $arrayIdparticipantsOfApeTest)) {                                                echo '<option value="'.$value->getIdParticipant().'">'.$value->getSurname().' '.$value->getName().'</option>';                                            }                                        }                                        ?>                                    </select>                                    <?php if($isOtherPf) { ?>                                    <br/><br/>                                    <div class="text-center">                                        <button type="button" id="associateExistingSalespersonButton" name="associateExistingSalespersonButton" class="btn m-t-md m-b hvr-icon-spin text-center">Enregistrer</button>                                    </div>                                    <?php } ?>                                </div>                                </form>                                <div class="text-center">                                    <button type="button" id="addNewParticipantButton" name="addNewParticipantButton" class="btn m-t-md m-b hvr-icon-float-away" data-toggle="modal" data-target="#myModal">Nouveau responsable de commission ?</button>                                </div>                            </div><!-- ./row -->                        </div>                        <?php if(!$isOtherPf) { ?>                        <div class="ibox-footer">                            <button id="nextButton" name="nextButton" type="button" class="btn hvr-icon-forward pull-right">Suivant</button>                            <button id="previousButton" name="previousButton" type="button" class="btn hvr-icon-back">Précédent</button>                        </div>                        <?php } ?>                    </div>                </div>                                                            </div><!-- ./row -->                        <div class="row" style="height:40px">                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                    &nbsp;                </div>            </div>            <div class="footer">                <div class="pull-right">                    <strong><i class="fa fa-copyright" aria-hidden="true"></i></strong> E.Leclerc | SCA Ouest <?php echo date('Y'); ?>                </div>                <div>                    <strong>PFManagement</strong>                </div>            </div>        </div>        </div>    <!-- Mainly scripts -->    <script src="js/jquery-3.1.1.min.js"></script>    <script src="js/bootstrap.min.js"></script>    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>        <!-- iCheck -->    <script src="js/plugins/iCheck/icheck.min.js"></script>        <!-- Select2 -->    <script src="js/plugins/select2/select2.full.min.js"></script>    <script src="js/plugins/select2/i18n/fr.js"></script>    <!-- Toastr script -->    <script src="js/plugins/toastr/toastr.min.js"></script>    <!-- Custom and plugin javascript -->    <script src="js/inspinia.js"></script>    <script src="js/plugins/pace/pace.min.js"></script>        <!-- Bootbox -->    <script src="js/plugins/bootbox.js/bootbox.min.js"></script>    <!-- Custom script -->    <script>            // select2 activation    $("#selectExistingSalespersons").select2( { placeholder: "--- Choix Commercial (NOM Prénom) ---", language: "fr" });        // icheck class    $(document).ready(function () {        $('.i-checks').iCheck({            checkboxClass: 'icheckbox_square-green',            radioClass: 'iradio_square-green'        });    });        // Nbparticipants => Default zero    $("#infoNbParticipants").text("0");        // Check i checkbox are checked/unchecked, conflict with JQuery listeners    // paseInt : The radix parameter is used to specify which numeral system to be used    $('input').on('ifChecked', function(event){ $("#infoNbParticipants").text( parseInt( $("#infoNbParticipants").text(),10) + 1 ); });    $('input').on('ifUnchecked', function(event){ $("#infoNbParticipants").text( parseInt( $("#infoNbParticipants").text(),10) - 1 ); });        // Check/Uncheck All Checkboxes    function checkAllCheckboxes() { $('input').iCheck('check'); }    function uncheckAllCheckboxes() { $('input').iCheck('uncheck'); }        // Previous/Next buttons    $("#previousButton").click(function(){ window.location.assign("./purchasing_fair_list.php"); });    $("#nextButton").click(function(){                var checkedValues = $('input:checkbox:checked').map(function() {            return this.value;        }).get();        var Allcheckbox = $('input:checkbox').map(function() {                return this.value;        }).get();                        $.post(            './ajax/salespersonsIntoSession.php',            {                salespersons : JSON.stringify(checkedValues),                AllSalespersons : JSON.stringify(Allcheckbox),                salespersonsFormOtherProviders : JSON.stringify($('#selectExistingSalespersons').select2('val'))            },            function(data) {                if(data.trim() === 'Success') {                    window.location.assign("./admin_list_of_stores_by_salesperson.php");                }                else {                    console.log(data);                    alert("Erreur. Aucun responsable de commission sélectionné.");                }            },            'text'        );        });        $("#associateExistingSalespersonButton").click(function(){                 var checkedValues = $('input:checkbox:checked').map(function() {            return this.value;        }).get();                        $.post(            './ajax/salespersonsIntoSession.php',            {                salespersons : JSON.stringify(checkedValues),                salespersonsFormOtherProviders : JSON.stringify($('#selectExistingSalespersons').select2('val'))            },            function(data) {                if(data.trim() === 'Success') {                    window.location.assign("./admin_salesperson_list.php");                }                else {                    alert("Erreur. Aucun responsable de commission sélectionné.");                }            },            'text'        );        });        // Check the register of a new Participant via modal    // Be careful : bug if .click() used, prefer .on('click'...)    // Modal is not ready with $(document).ready function. It becomes ready when it pops-up -> .click() does not work.    // If you load HTML content dynamically (AJAX call for example, modals) and you want to binder an event on this content,     // you will have to go through the function $ (...). (...),     // the click() function applies to the elements present in the DOM during the initial loading of the page :)    // Src 1 : https://stackoverflow.com/questions/22178892/jquery-click-event-not-working-in-bootstrap-modal    // Src 2 : https://www.grafikart.fr/forum/topics/20546    // Src 3 : https://stackoverflow.com/questions/9122078/difference-between-onclick-vs-click        $(document).on('click', '#saveNewParticipantButton', function() {                var isOK = true;                if( $("#newParticipantCivility").val() == 0) {            isOK = false;            $("#newParticipantCivility").addClass("errorInput");        } else { $("#newParticipantCivility").addClass("successInput"); }                if( $.trim( $("#newParticipantSurname").val() ) === '') {            isOK = false;            $("#newParticipantSurname").addClass("errorInput");        } else { $("#newParticipantSurname").addClass("successInput"); }                if( $.trim( $("#newParticipantName").val() ) === '') {            isOK = false;            $("#newParticipantName").addClass("errorInput");        } else { $("#newParticipantName").addClass("successInput"); }                if( $.trim( $("#newParticipantEMail").val() ) === '') {            isOK = false;             $("#newParticipantEMail").addClass("errorInput");        } else { $("#newParticipantEMail").addClass("successInput"); }        if (isOK === true) $("#saveNewParticipantForm").submit();     });    <?php if( isset($_POST) && !empty($_POST) && $idParticipantSaved) { ?>    toastr.success('Nouveau Participant enregistré.', 'OK.');    <?php } elseif(isset($_POST) && !empty($_POST) && !$idParticipantSaved) { ?>    toastr.error('Participant non renregistré (existe déjà).', 'Échec');    <?php }?>            // Bootbox        bootbox.setDefaults({ locale: "fr" });        function deleteASS(rowId, idParticipant, idProvider, idPurchasingFair) {                bootbox.confirm("Confirmer la suppression ?", function(result) {                                     if(result === true) {                                $.post(                    './ajax/deleteASS.php',                    {                        idParticipant    : idParticipant,                        idProvider       : idProvider,                        idPurchasingFair : idPurchasingFair                    },                    function(data) {                        if(data.trim() === 'Success') {                            $('#rowASS_' + rowId).html('<span class="text-danger"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;Participation supprimée.</span>');                            toastr.success('Action réussie', 'Succès.');                        }                        else {                            toastr.error('Erreur fatale. Contactez l\'administrateur.', 'Échec.');                        }                    },                    'text'                );                            }        });    }        function deleteAPEAndASS(idParticipant, idProvider, idPurchasingFair) {                bootbox.confirm("Confirmer la suppression ?", function(result) {                                     if(result === true) {                                $.post(                    './ajax/deleteAPEAndASS.php',                    {                        idParticipant    : idParticipant,                        idProvider       : idProvider,                        idPurchasingFair : idPurchasingFair                    },                    function(data) {                        if(data.trim() === 'Success') {                            $('#rowParticipant_' + idParticipant).html('<span class="text-danger"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;Le Responsable de commission n\'est plus affecté a la commisssion et ses affectations Fournisseur ont été supprimées.</span>');                            toastr.success('Action réussie', 'Succès.');                        }                        else {                            toastr.error('Erreur fatale. Contactez l\'administrateur.', 'Échec.');                        }                    },                    'text'                );                            }        });    }    </script>    <!--     ---- Bug Internet Explorer 30/01/2018 : Bootstrap modal appearing under background    ---- Easiest way is to just move the modal div so it is outside any elements with special positioning.     ---- One good place might be just before the closing body tag </body>.    ---- Src : https://stackoverflow.com/questions/10636667/bootstrap-modal-appearing-under-background    -->    <div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">        <div class="modal-dialog">            <div class="modal-content animated fadeIn">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>                    <i class="fa fa-id-badge fa-2x"></i>                    <h4 class="modal-title">Nouveau Commercial</h4>                </div>                <div class="modal-body">                    <form id="saveNewParticipantForm" role="form" action="./admin_salesperson_list.php" method="POST">                        <div class="form-group"><label>Civilité</label>                            <select id="newParticipantCivility" name="newParticipantCivility" class="form-control" required="">                                <option value="0">-- Choix civilité --</option>                                <option value="Madame">Madame</option>                                <option value="Monsieur">Monsieur</option>                            </select>                        </div>                        <div class="form-group"><label>Nom</label>                            <input type="text" id="newParticipantSurname" name="newParticipantSurname" maxlength="50" class="form-control" required="">                        </div>                        <div class="form-group"><label>Prénom</label>                            <input type="text" id="newParticipantName" name="newParticipantName" maxlength="50" class="form-control" required="">                        </div>                        <div class="form-group"><label>E-mail</label>                            <input type="email" id="newParticipantEMail" name="newParticipantEMail"  maxlength="100" class="form-control" required="">                        </div>                    </form>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-white" data-dismiss="modal" style="margin:0!important">Fermer</button>                    <button id="saveNewParticipantButton" type="button" class="btn btn-primary">Enregistrer</button>                </div>            </div>        </div>    </div></body></html>